#!/bin/bash

if [[ ${#} -ne 1 ]]; then
  echo "Usage: ${0} revision" >&2
  exit 1
fi

if [[ ! ${OSTYPE} =~ darwin ]]; then
  open() {
    xdg-open ${1} >/dev/null
  }
fi

pr=$(
  git log ${1}..origin/master --merges --ancestry-path --reverse --oneline \
    | head -n1 \
    | awk '$0 = substr($5, 2)'
)
if [[ -z ${pr} ]]; then
  exit 1
fi

origin=$(git config --get remote.origin.url)
case ${origin} in
  https://* )
    open "${origin}/pull/${pr}" ;;
  ssh://* )
    open "https://github.com/$(echo ${origin} | awk -F/ '{ printf "%s/%s", $4, $5 }')/pull/${pr}" ;;
  * )
    open "https://github.com/$(echo ${origin} | awk -F[:.] '$0 = $3')/pull/${pr}" ;;
esac
